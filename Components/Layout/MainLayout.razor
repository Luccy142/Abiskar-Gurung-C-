@namespace JournalApp.Components.Layout
@using JournalApp.Services.Interfaces
@using Microsoft.JSInterop
@inherits LayoutComponentBase
@implements IDisposable
@inject IThemeService ThemeService
@inject IJSRuntime JSRuntime

<div class="app-shell">
    <aside class="sidebar">
        <NavMenu />
    </aside>

    <main class="main">
        @Body
    </main>
</div>

<style>
    .app-shell {
        display: flex;
        min-height: 100vh;
    }

    .sidebar {
        width: 320px;
        flex: 0 0 320px;
    }

    .main {
        flex: 1;
        min-width: 0;
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ThemeService.ThemeChanged += HandleThemeChanged;
            await ApplyThemeAsync(ThemeService.GetTheme());
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task ApplyThemeAsync(string theme)
    {
        var normalized = theme == "dark" ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("themeHelper.setTheme", normalized);
    }

    private async void HandleThemeChanged(string theme)
    {
        await InvokeAsync(() => ApplyThemeAsync(theme));
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= HandleThemeChanged;
    }
}
