@namespace JournalApp.Components.Layout
@using JournalApp.Services.Interfaces
@using JournalApp.Services.Implementations
@using Microsoft.JSInterop
@inherits LayoutComponentBase
@implements IDisposable
@inject IThemeService ThemeService
@inject IJSRuntime JSRuntime
@inject SessionService Session
@inject NavigationManager Nav

@if (!Session.IsUnlocked && 
     !Nav.Uri.Contains("/lock", StringComparison.OrdinalIgnoreCase))
{
    <div style="display:none">@{ Nav.NavigateTo("/lock", true); }</div>
}

@* Always show app shell now that lock is removed/softened *@
    <div class="app-shell">
        <aside class="sidebar">
            <NavMenu />
        </aside>

        <main class="main">
            @Body
        </main>
    </div>

<style>
    .app-shell {
        display: flex;
        min-height: 100vh;
    }

    .sidebar {
        width: 320px;
        flex: 0 0 320px;
    }

    .main {
        flex: 1;
        min-width: 0;
    }
</style>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ThemeService.ThemeChanged += HandleThemeChanged;
            await ApplyThemeAsync(ThemeService.GetTheme());

            // Initial lock check
            if (!Session.IsUnlocked && !Nav.Uri.Contains("/lock", StringComparison.OrdinalIgnoreCase))
            {
               Nav.NavigateTo("/lock", true);
            }
        }

        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task ApplyThemeAsync(string theme)
    {
        var normalized = theme == "dark" ? "dark" : "light";
        await JSRuntime.InvokeVoidAsync("themeHelper.setTheme", normalized);
    }

    private async void HandleThemeChanged(string theme)
    {
        await InvokeAsync(() => ApplyThemeAsync(theme));
    }

    public void Dispose()
    {
        ThemeService.ThemeChanged -= HandleThemeChanged;
    }
}
